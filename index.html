<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>買い出しローテーション Todo</title>
  <style>
    /* ここにCSSを後で追加します */
    :root {
      --bg-color: #f7f8fa;
      --text-color: #222;
      --header-bg: linear-gradient(90deg, #7f7fd5 0%, #86a8e7 50%, #91eac9 100%);
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --card-bg: #fff;
      --border-color: #e5e7eb;
      --modal-bg: rgba(30, 41, 59, 0.25);
      --modal-card-bg: #fff;
      --shadow: 0 4px 24px rgba(0,0,0,0.10);
      --success: #10b981;
      --success-hover: #059669;
      --warning: #f59e0b;
      --warning-hover: #d97706;
      --history-bg: #f8fafc;
      --history-border: #e2e8f0;
    }
    body.dark {
      --bg-color: #232323;
      --text-color: #f7f7f7;
      --header-bg: linear-gradient(90deg, #232526 0%, #414345 100%);
      --accent: #a78bfa;
      --accent-hover: #7c3aed;
      --card-bg: #23272f;
      --border-color: #444;
      --modal-bg: rgba(30, 41, 59, 0.55);
      --modal-card-bg: #23272f;
      --shadow: 0 4px 24px rgba(0,0,0,0.30);
      --history-bg: #1e293b;
      --history-border: #334155;
    }
    body {
      background: #fffbe7;
      color: #222;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', 'Segoe UI', 'Hiragino Sans', Arial, sans-serif;
      letter-spacing: 0.01em;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #232323;
      color: #f7f7f7;
    }
    header {
      background: #fff;
      border-bottom: 1.2px solid #ffe066;
      border-radius: 0 0 24px 24px;
      box-shadow: none;
      padding: 2.2rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    body.dark header {
      background: #232323;
      border-bottom: 1.2px solid #ffe066;
    }
    h1 {
      font-size: 2.1rem;
      font-weight: 900;
      color: #222;
      margin: 0;
      letter-spacing: 0.08em;
      background: #ffe066;
      display: inline-block;
      padding: 0.2em 1.2em;
      border-radius: 12px;
      box-shadow: none;
    }
    body.dark h1 {
      color: #232323;
      background: #ffe066;
    }
    header .header-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5em;
      background: #222;
      color: #fff;
      border: 1.2px solid #222;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.01rem;
      padding: 0.5em 1.3em;
      margin-left: 0.7em;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: none;
      height: 2.5em;
    }
    header .header-btn svg {
      width: 1.2em;
      height: 1.2em;
      margin-right: 0.3em;
    }
    header .header-btn:hover {
      background: #ffe066;
      color: #222;
      border: 1.2px solid #ffe066;
    }
    body.dark header .header-btn {
      background: #ffe066;
      color: #232323;
      border: 1.2px solid #ffe066;
    }
    body.dark header .header-btn:hover {
      background: #222;
      color: #fff;
      border: 1.2px solid #222;
    }
    section {
      background: #fff;
      border-radius: 16px;
      box-shadow: none;
      margin: 2.2rem auto;
      padding: 2rem 1.5rem;
      max-width: 540px;
      border: 1.2px solid #222;
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    body.dark section {
      background: #232323;
      border: 1.2px solid #ffe066;
      color: #f7f7f7;
    }
    h2, h3 {
      color: #222;
      font-weight: 900;
      margin-top: 0;
      margin-bottom: 0.7em;
      letter-spacing: 0.04em;
      background: #ffe066;
      display: inline-block;
      padding: 0.2em 1.2em;
      border-radius: 10px;
      border: 1.2px solid #222;
    }
    body.dark h2, body.dark h3 {
      color: #232323;
      background: #ffe066;
      border: 1.2px solid #ffe066;
    }
    form {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    button, .self-indicator-badge, .self-set-btn, .delete-btn {
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.01rem;
      border: 1.2px solid #222;
      padding: 0.5em 1.2em;
      margin: 0 0.2em;
      box-shadow: none;
      transition: background 0.2s, color 0.2s, border 0.2s, transform 0.1s;
    }
    button[type="submit"], .self-set-btn {
      background: #ffe066;
      color: #222;
      border: 1.2px solid #ffe066;
    }
    button[type="submit"]:hover, .self-set-btn:hover {
      background: #fffbe7;
      color: #222;
      border: 1.2px solid #222;
      transform: translateY(-1px) scale(1.04);
    }
    .delete-btn {
      background: #fff;
      color: #e63946;
      border: 1.2px solid #e63946;
      font-weight: 700;
    }
    .delete-btn:hover {
      background: #ffe066;
      color: #b5171e;
      border: 1.2px solid #b5171e;
    }
    .self-indicator-badge {
      background: #222;
      color: #fff;
      min-width: 7.1em;
      font-size: 1.01rem;
      font-weight: 700;
      border: 1.2px solid #222;
    }
    body.dark .self-indicator-badge {
      background: #ffe066;
      color: #232323;
      border: 1.2px solid #ffe066;
    }
    input[type="text"], input[type="number"] {
      border-radius: 8px;
      border: 1.2px solid #222;
      background: #fffbe7;
      padding: 0.7em 1.1em;
      font-size: 1.01rem;
      margin-right: 0.5em;
      margin-bottom: 0.5em;
      color: #222;
      transition: border 0.2s, background 0.2s, color 0.2s;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      border: 1.2px solid #ffe066;
      outline: none;
    }
    body.dark input[type="text"], body.dark input[type="number"] {
      background: #232323;
      color: #f7f7f7;
      border: 1.2px solid #ffe066;
    }
    .color-circle-picker {
      width: 2em;
      height: 2em;
      border-radius: 50%;
      border: 1.2px solid #222;
      background: #fff;
      margin: 0 auto;
      display: block;
      cursor: pointer;
      transition: border 0.2s;
    }
    .color-circle-picker:hover, .color-circle-picker:focus {
      border: 1.2px solid #ffe066;
    }
    body.dark .color-circle-picker {
      background: #232323;
      border: 1.2px solid #ffe066;
    }
    input[type="color"]::-webkit-color-swatch {
      border-radius: 50%;
      border: none;
    }
    input[type="color"]::-webkit-color-swatch-wrapper {
      border-radius: 50%;
      padding: 0;
    }
    input[type="color"]::-moz-color-swatch {
      border-radius: 50%;
      border: none;
    }
    input[type="color"]::-moz-focus-inner {
      border-radius: 50%;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0 0 0.5em 0;
    }
    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.7em 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 1rem;
    }
    li:last-child {
      border-bottom: none;
    }
    .task-info {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 0.2em;
    }
    .task-actions {
      display: flex;
      gap: 0.5em;
    }
    .done {
      text-decoration: line-through;
      opacity: 0.6;
    }
    /* 完了ボタンの改良 */
    .complete-btn {
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 0.4em 1em;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
      position: relative;
      overflow: hidden;
    }
    .complete-btn:hover {
      background: var(--success-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .complete-btn.undo {
      background: var(--warning);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
    }
    .complete-btn.undo:hover {
      background: var(--warning-hover);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    .complete-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    .complete-btn:active::before {
      width: 100px;
      height: 100px;
    }
    /* 在庫更新の改良 */
    .stock-item {
      background: var(--history-bg);
      border: 1px solid var(--history-border);
    }
    .stock-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .stock-item.updated {
      animation: stockUpdate 0.6s ease;
    }
    @keyframes stockUpdate {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); background: #dbeafe; }
      100% { transform: scale(1); }
    }
    .stock-input {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 0.4em 0.6em;
      font-size: 1rem;
      color: var(--text-color);
      transition: all 0.2s ease;
      width: 4em;
      text-align: center;
    }
    .stock-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    .stock-input.updated {
      background: #dbeafe;
      border-color: var(--accent);
    }
    /* 買い物履歴 */
    .history-section {
      background: var(--history-bg);
      border: 1px solid var(--history-border);
    }
    .history-item {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 0.8em;
      margin-bottom: 0.5em;
      border-left: 4px solid var(--success);
      font-size: 0.95rem;
    }
    .history-date {
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.3em;
    }
    /* 買い物担当ボタン */
    .volunteer-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: #fff;
      border: none;
      border-radius: 25px;
      padding: 0.8em 1.5em;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
      margin: 1em 0;
      width: 100%;
    }
    .volunteer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }
    .volunteer-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .volunteer-info {
      background: var(--accent);
      color: #fff;
      padding: 0.8em;
      border-radius: 12px;
      margin: 1em 0;
      text-align: center;
      font-weight: 600;
    }
    /* 自分設定 */
    .self-indicator {
      background: #10b981;
      color: #fff;
      padding: 0.2em 0.7em;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 0.5em;
      display: inline-block;
    }
    /* モーダル */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: var(--modal-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .modal-content {
      background: var(--modal-card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 2.2rem 1.5rem 1.5rem 1.5rem;
      min-width: 320px;
      max-width: 98vw;
      width: 540px;
      border: 1.5px solid var(--border-color);
      position: relative;
      animation: modalIn 0.18s cubic-bezier(.4,2,.6,1) both;
      max-height: 90vh;
      overflow-y: auto;
    }
    @keyframes modalIn {
      0% { transform: translateY(40px) scale(0.98); opacity: 0; }
      100% { transform: none; opacity: 1; }
    }
    .modal-content section {
      background: none;
      box-shadow: none;
      border: none;
      margin: 0 0 1.2em 0;
      padding: 0;
      max-width: 100%;
    }
    .modal-content input, .modal-content button {
      margin-bottom: 0.2em;
    }
    .modal-content ul {
      margin-bottom: 0.5em;
    }
    .modal-content button {
      min-width: 60px;
    }
    /* --- 住民リストの自分ボタン --- */
    .self-set-btn {
      background: linear-gradient(90deg, #34d399 0%, #10b981 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 0.3em 1.1em 0.3em 1.1em;
      font-size: 0.97rem;
      font-weight: 600;
      min-width: 6.2em;
      text-align: center;
      box-sizing: border-box;
      vertical-align: middle;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(16,185,129,0.08);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      outline: none;
    }
    .self-set-btn:hover {
      background: linear-gradient(90deg, #059669 0%, #10b981 100%);
      box-shadow: 0 4px 16px rgba(16,185,129,0.13);
      transform: translateY(-1px) scale(1.04);
    }
    /* --- 削除ボタン --- */
    .delete-btn {
      background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 0.3em;
      font-size: 0.97rem;
      font-weight: 600;
      cursor: pointer;
      margin-left: 0.5em;
      box-shadow: 0 2px 8px rgba(239,68,68,0.08);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }
    .delete-btn:hover {
      background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
      box-shadow: 0 4px 16px rgba(239,68,68,0.13);
      transform: translateY(-1px) scale(1.04);
    }
    @media (max-width: 600px) {
      header, section {
        max-width: 99vw;
        padding: 1rem 0.5rem;
      }
      h1 {
        font-size: 1.2rem;
      }
      h2 {
        font-size: 1.05rem;
      }
      .modal-content {
        min-width: 0;
        width: 98vw;
        padding: 1.2rem 0.5rem 1rem 0.5rem;
      }
      form {
        flex-direction: column;
        gap: 0.3em;
      }
      input, button {
        font-size: 0.97rem;
      }
    }
    @keyframes slideIn {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    .settings-tabs {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    .tab-btn {
      background: #fffbe7;
      color: #222;
      border: 1.2px solid #222;
      border-radius: 10px 10px 0 0;
      padding: 0.6em 1.5em;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      border-bottom: 1.2px solid #ffe066;
    }
    .tab-btn.active {
      background: #ffe066;
      color: #222;
      border-bottom: 1.2px solid #222;
      z-index: 2;
    }
    #member-section, #stockitem-section {
      margin-top: 0;
      padding-top: 0;
    }
    /* 在庫バッジ */
    .stock-badge {
      display: inline-flex;
      align-items: center;
      background: #ffe066;
      color: #222;
      font-weight: 700;
      font-size: 0.97rem;
      border-radius: 8px;
      padding: 0.18em 0.8em 0.18em 0.6em;
      margin-right: 0.7em;
      margin-bottom: 0.2em;
      border: 1.2px solid #222;
      gap: 0.4em;
    }
    .stock-badge .icon {
      font-size: 1.1em;
      margin-right: 0.2em;
    }
    /* 担当バッジ */
    .member-badge {
      display: inline-block;
      background: linear-gradient(90deg, #d1fae5 0%, #6ee7b7 100%);
      color: #047857;
      font-weight: 700;
      font-size: 0.97rem;
      border-radius: 12px;
      padding: 0.18em 0.9em;
      margin-left: 0.5em;
      margin-bottom: 0.2em;
      box-shadow: 0 2px 8px rgba(16,185,129,0.08);
    }
    .member-badge.undecided {
      background: #fffbe7;
      color: #aaa;
      border: 1.2px dashed #aaa;
    }
    .task-info-label {
      font-size: 0.93rem;
      color: #222;
      font-weight: 700;
      margin-right: 0.5em;
      letter-spacing: 0.03em;
    }
    /* 買う個数・担当の横並び行 */
    .task-row-info {
      display: flex;
      align-items: center;
      gap: 1.2em;
      margin: 0.3em 0 0.7em 0;
      font-size: 1.02rem;
    }
    .buy-amount-badge {
      display: inline-flex;
      align-items: center;
      background: #ffe066;
      color: #222;
      font-weight: 700;
      border-radius: 8px;
      padding: 0.18em 0.8em 0.18em 0.6em;
      font-size: 0.98rem;
      gap: 0.4em;
    }
    .buy-amount-badge .icon {
      font-size: 1.1em;
      margin-right: 0.2em;
    }
    .task-member-label {
      color: #222;
      font-weight: 600;
      margin-right: 0.2em;
      font-size: 0.98rem;
    }
    body.dark .task-member-label {
      color: #ffe066;
    }
    .task-member-name {
      color: #222;
      font-weight: 700;
      font-size: 0.98rem;
      margin-left: 0.1em;
      background: #ffe066;
      border-radius: 8px;
      padding: 0.1em 0.7em;
      border: 1.2px solid #222;
    }
    body.dark .task-member-name {
      color: #232323;
      background: #ffe066;
      border: 1.2px solid #ffe066;
    }
    .task-member-name.undecided {
      color: #aaa;
      background: #fffbe7;
      border: 1.2px dashed #aaa;
    }
    body.dark .task-member-name.undecided {
      color: #aaa;
      background: #232323;
      border: 1.2px dashed #ffe066;
    }
    /* 住人リストの行レイアウト・デザイン改善 */
    #member-section {
      background: #fffbe7;
      border-radius: 12px;
      border: 1.2px solid #222;
      padding: 1.2em 1.2em 1em 1.2em;
      margin-bottom: 1em;
      margin-top: 0.5em;
      box-shadow: none;
    }
    body.dark #member-section {
      background: #232323;
      border: 1.2px solid #ffe066;
    }
    #member-list {
      margin-bottom: 1em;
      padding: 0.5em 0.2em 0.5em 0.2em;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #eee;
    }
    body.dark #member-list {
      background: #232323;
      border: 1px solid #444;
    }
    #member-list li {
      margin-bottom: 0.7em;
      background: #fffbe7;
      border-radius: 12px;
      padding: 0.7em 1.2em;
      min-height: 3.2em;
      display: flex;
      align-items: center;
      gap: 1.5em;
      border: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
      flex-wrap: nowrap;
    }
    body.dark #member-list li {
      background: #232323;
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
    }
    .member-name-label {
      font-weight: 600;
      font-size: 1.08rem;
      min-width: 5.5em;
      margin-right: 0.7em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 7em; /* 5文字程度まで改行なし */
      display: inline-block;
      vertical-align: middle;
    }
    .color-picker-wrap {
      min-width: 2.5em;
      margin-right: 0.7em;
      flex-shrink: 0;
    }
    .member-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.7em;
      margin-left: 0.5em;
      flex-wrap: nowrap;
      width: 100%;
    }
    .self-set-btn, .delete-btn, .self-indicator-badge {
      white-space: nowrap;
      min-width: 6em;
      flex-shrink: 0;
      font-size: 1.01rem;
      padding: 0.3em 1.1em;
    }
    .self-indicator-badge {
      background: #10b981 !important; /* グリーンで目立たせる */
      color: #fff !important;
      border: 1.2px solid #10b981 !important;
      font-weight: 700;
      font-size: 1.01rem;
      padding: 0.3em 1.1em;
      min-width: 6em;
      text-align: center;
      box-shadow: 0 2px 8px rgba(16,185,129,0.08);
    }
    .self-set-btn {
      background: #e5e7eb !important; /* 控えめなグレー */
      color: #222 !important;
      border: 1.2px solid #bbb !important;
      font-weight: 700;
      font-size: 1.01rem;
      padding: 0.3em 1.1em;
      min-width: 6em;
      text-align: center;
    }
    .self-set-btn:hover {
      background: #d1d5db !important;
      color: #222 !important;
      border: 1.2px solid #222 !important;
    }
    #new-member {
      margin-right: 0.5em;
      margin-bottom: 0.5em;
      padding: 0.6em 1em;
      border-radius: 8px;
      border: 1.2px solid #222;
      background: #fff;
      font-size: 1.01rem;
    }
    #add-member {
      padding: 0.6em 1.5em;
      border-radius: 8px;
      font-size: 1.01rem;
      margin-bottom: 0.5em;
    }
    .volunteer-btn, .complete-btn {
      border: 1.2px solid #222;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.01rem;
      background: #ffe066;
      color: #222;
      box-shadow: none;
      padding: 0.5em 1.2em;
      margin: 0 0.2em;
      transition: background 0.2s, color 0.2s, border 0.2s, transform 0.1s;
    }
    .volunteer-btn:hover, .complete-btn:hover {
      background: #fffbe7;
      color: #222;
      border: 1.2px solid #222;
      transform: translateY(-1px) scale(1.04);
    }
    body.dark .volunteer-btn, body.dark .complete-btn {
      background: #232323;
      color: #ffe066;
      border: 1.2px solid #ffe066;
    }
    body.dark .volunteer-btn:hover, body.dark .complete-btn:hover {
      background: #ffe066;
      color: #232323;
      border: 1.2px solid #ffe066;
    }
    .complete-btn.undo {
      background: #fff;
      color: #f59e42;
      border: 1.2px solid #f59e42;
    }
    .complete-btn.undo:hover {
      background: #ffe066;
      color: #b5171e;
      border: 1.2px solid #b5171e;
    }
    .history-section, .stock-item {
      background: #fffbe7;
      border: 1.2px solid #222;
      border-radius: 10px;
      margin-bottom: 1em;
      box-shadow: none;
    }
    body.dark .history-section, body.dark .stock-item {
      background: #232323;
      border: 1.2px solid #ffe066;
    }
    .history-item {
      background: #fff;
      border-radius: 8px;
      padding: 0.8em;
      margin-bottom: 0.5em;
      border-left: 4px solid #ffe066;
      font-size: 0.95rem;
    }
    body.dark .history-item {
      background: #232323;
      border: 1.2px solid #ffe066;
      border-left: 4px solid #ffe066;
    }
    .history-content {
      display: flex;
      align-items: center;
      gap: 0.5em;
      flex-wrap: wrap;
    }
    .history-member {
      color: #fff;
      font-weight: 700;
      font-size: 0.9rem;
      border-radius: 999px;
      padding: 0.2em 0.8em;
      display: inline-block;
      border: 2.2px solid #222;
    }
    .history-price {
      background: #fbbf24;
      color: #222;
      font-weight: 900;
      font-size: 1rem;
      border-radius: 8px;
      padding: 0.2em 0.6em;
      border: 2.2px solid #222;
      margin-left: 0.5em;
    }
    .history-total {
      background: #ffe066;
      border-radius: 8px;
      padding: 1em;
      margin-top: 1em;
      border: 2.2px solid #222;
      text-align: center;
    }
    .history-total-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: #222;
    }
    .history-total-price {
      background: #fbbf24;
      color: #222;
      font-weight: 900;
      font-size: 1.2rem;
      border-radius: 8px;
      padding: 0.3em 0.8em;
      border: 2.2px solid #222;
      margin-left: 0.5em;
    }
    .history-member-totals {
      background: #fffbe7;
      border-radius: 8px;
      padding: 0.7em 1em;
      margin-top: 1em;
      border: 2.2px solid #222;
      box-sizing: border-box;
      margin-bottom: 0.5em;
    }
    .history-member-totals-title {
      font-size: 1rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 0.8em;
      text-align: center;
    }
    .history-member-total {
      display: inline-flex;
      align-items: center;
      margin-right: 1em;
      margin-bottom: 0.3em;
      padding: 0;
      gap: 0.7em;
    }
    .history-member-total:last-child {
      margin-bottom: 0;
    }
    .history-member-amount {
      background: #fbbf24;
      color: #222;
      font-weight: 900;
      font-size: 1rem;
      border-radius: 8px;
      padding: 0.2em 0.8em 0.25em 0.8em;
      border: 2.2px solid #222;
      margin-left: 0.2em;
      line-height: 1.7;
      vertical-align: middle;
      box-sizing: border-box;
      display: inline-block;
    }
    .history-date {
      color: #222;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.3em;
      background: #ffe066;
      border-radius: 8px;
      padding: 0.1em 0.7em;
      display: inline-block;
      border: 1.2px solid #222;
    }
    body.dark .history-date {
      color: #232323;
      background: #ffe066;
      border: 1.2px solid #ffe066;
    }
    .settings-tabs {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    .tab-btn {
      background: #fffbe7;
      color: #222;
      border: 1.2px solid #222;
      border-radius: 10px 10px 0 0;
      padding: 0.6em 1.5em;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      border-bottom: 1.2px solid #ffe066;
    }
    .tab-btn.active {
      background: #ffe066;
      color: #222;
      border-bottom: 1.2px solid #222;
      z-index: 2;
    }
    body.dark .tab-btn {
      background: #232323;
      color: #ffe066;
      border: 1.2px solid #ffe066;
      border-bottom: 1.2px solid #ffe066;
    }
    body.dark .tab-btn.active {
      background: #ffe066;
      color: #232323;
      border-bottom: 1.2px solid #232323;
    }
    @media (max-width: 600px) {
      header, section {
        max-width: 99vw;
        padding: 1rem 0.5rem;
      }
      h1 {
        font-size: 1.2rem;
      }
      h2 {
        font-size: 1.05rem;
      }
      .modal-content {
        min-width: 0;
        width: 98vw;
        padding: 1.2rem 0.5rem 1rem 0.5rem;
      }
      form {
        flex-direction: column;
        gap: 0.3em;
      }
      input, button {
        font-size: 0.97rem;
      }
    }
    /* --- CSS修正 --- */
    section, .history-section, .stock-item, #member-list li, .buy-amount-badge, .stock-badge, .member-badge, .task-member-name, .tab-btn, .header-btn, button, .self-indicator-badge, .delete-btn, .volunteer-btn, .complete-btn, input[type="text"], input[type="number"], .color-circle-picker, .history-item, .history-date {
      border-width: 2.2px !important;
      border-style: solid !important;
      border-color: #222 !important;
    }

    .task-row-info {
      gap: 0.5em;
    }
    .task-member-label {
      margin-right: 0.1em;
    }
    .task-member-name {
      padding: 0.1em 1.1em;
      font-weight: 700;
      border-radius: 8px;
      border: 2.2px solid #222;
      margin-left: 0.1em;
      display: inline-block;
    }



    /* --- 在庫数の更新 --- */
    #stock-list .stock-item {
      background: #fffbe7;
      border: 2.2px solid #222;
      border-radius: 12px;
      margin-bottom: 1em;
      padding: 1.2em 1.2em 1em 1.2em;
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      box-shadow: none;
    }
    #stock-list .stock-item strong {
      font-size: 1.1em;
      font-weight: 700;
    }
    #stock-list .stock-item .stock-info-row {
      display: flex;
      align-items: center;
      gap: 1.2em;
      margin-top: 0.5em;
    }
    #stock-list .stock-input {
      border-radius: 8px;
      border: 2.2px solid #222;
      background: #fff;
      padding: 0.4em 0.8em;
      font-size: 1.1em;
      width: 4em;
      text-align: center;
      margin: 0 0.5em;
    }
    #stock-list .stock-badge {
      background: #ffe066;
      color: #222;
      border-radius: 8px;
      font-weight: 700;
      padding: 0.1em 0.8em;
      border: 2.2px solid #222;
      margin-left: 0.5em;
    }

    /* --- ストック品リスト登録 --- */
    #stockitem-section {
      background: #fffbe7;
      border-radius: 12px;
      border: 2.2px solid #222;
      padding: 1em 1.2em;
      margin-bottom: 1em;
    }
    #stockitem-list li {
      background: #fff;
      border-radius: 12px;
      border: 2.2px solid #ffe066;
      margin-bottom: 1em;
      padding: 1.2em 1.5em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    #stockitem-list li:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border-color: #fbbf24;
    }
    .stockitem-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.8em;
      flex: 1;
    }
    .stockitem-name {
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 900;
      font-size: 1.3rem;
      color: #222;
      background: #ffe066;
      padding: 0.3em 0.8em;
      border-radius: 8px;
      border: 2.2px solid #222;
      min-width: 4em;
      text-align: center;
    }
    .stockitem-rule {
      font-family: 'Montserrat', 'Futura', 'Arial', sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.8em;
      margin-left: 0.5em;
    }
    .stockitem-threshold {
      background: #f3f4f6;
      color: #374151;
      font-weight: 700;
      padding: 0.2em 0.6em;
      border-radius: 6px;
      border: 1.5px solid #d1d5db;
      font-size: 0.95rem;
      white-space: nowrap !important;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 4em;
    }
    .stockitem-arrow {
      color: #9ca3af;
      font-weight: 700;
      font-size: 1rem;
      white-space: nowrap;
    }
    .stockitem-buyamount {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 700;
      padding: 0.2em 0.6em;
      border-radius: 6px;
      border: 1.5px solid #93c5fd;
      font-size: 0.95rem;
      white-space: nowrap !important;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 4em;
    }
    
    /* 編集モードのスタイル */
    .stockitem-edit-mode .stockitem-name,
    .stockitem-edit-mode .stockitem-threshold,
    .stockitem-edit-mode .stockitem-buyamount {
      background: #fff !important;
      border: 2.2px solid #222 !important;
      padding: 0.3em 0.6em !important;
      border-radius: 8px !important;
      font-size: 1rem !important;
      text-align: center !important;
    }
    .stockitem-edit-mode .stockitem-name {
      font-weight: 700 !important;
      color: #222 !important;
      min-width: 4em !important;
    }
    .stockitem-edit-mode .stockitem-threshold {
      color: #374151 !important;
      width: 3em !important;
    }
    .stockitem-edit-mode .stockitem-buyamount {
      color: #1e40af !important;
      width: 3em !important;
    }
    .stockitem-edit-mode .stockitem-name {
      font-weight: 700 !important;
      color: #222 !important;
    }
    .stockitem-edit-mode .stockitem-threshold {
      color: #374151 !important;
    }
    .stockitem-edit-mode .stockitem-buyamount {
      color: #1e40af !important;
    }
    .stockitem-edit-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      margin-left: 1em;
    }
    .stockitem-edit-btn {
      background: #60a5fa !important;
      color: #fff !important;
      border: 2.2px solid #222 !important;
      border-radius: 999px !important;
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 44px !important;
      height: 44px !important;
      padding: 0 !important;
      box-shadow: none !important;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s !important;
      cursor: pointer !important;
    }
    .stockitem-edit-btn:hover {
      background: #2563eb !important;
      transform: translateY(-1px) scale(1.04) !important;
    }
    .stockitem-save-btn {
      background: #10b981 !important;
      color: #fff !important;
      border: 2.2px solid #222 !important;
      border-radius: 999px !important;
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 44px !important;
      height: 44px !important;
      padding: 0 !important;
      box-shadow: none !important;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s !important;
      cursor: pointer !important;
    }
    .stockitem-save-btn:hover {
      background: #059669 !important;
      transform: translateY(-1px) scale(1.04) !important;
    }
    .stockitem-cancel-btn {
      background: #f87171 !important;
      color: #fff !important;
      border: 2.2px solid #222 !important;
      border-radius: 999px !important;
      font-size: 1.1rem !important;
      font-weight: 700 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      width: 44px !important;
      height: 44px !important;
      padding: 0 !important;
      box-shadow: none !important;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s !important;
      cursor: pointer !important;
    }
    .stockitem-cancel-btn:hover {
      background: #dc2626 !important;
      transform: translateY(-1px) scale(1.04) !important;
    }
    #stockitem-section input[type="text"], #stockitem-section input[type="number"] {
      border-radius: 8px;
      border: 2.2px solid #222;
      background: #fff;
      padding: 0.4em 0.8em;
      font-size: 1.1em;
      margin-right: 0.3em;
    }
    #stockitem-section button:not(.stockitem-edit-btn):not(.stockitem-save-btn):not(.stockitem-cancel-btn):not(.delete-btn) {
      border-radius: 8px;
      border: 2.2px solid #222;
      background: #ffe066;
      color: #222;
      font-weight: 700;
      font-size: 1.05em;
      padding: 0.3em 1.1em;
      margin: 0 0.2em;
      min-width: 2.8em;
      transition: background 0.2s, color 0.2s;
    }
    #stockitem-section button:not(.stockitem-edit-btn):not(.stockitem-save-btn):not(.stockitem-cancel-btn):not(.delete-btn):hover {
      background: #fffbe7;
    }
    
    /* ストック品追加フォームのレイアウト */
    .stockitem-add-form {
      display: flex;
      flex-direction: column;
      gap: 0.8em;
      margin-top: 1em;
    }
    .stockitem-rule-inputs {
      display: flex;
      align-items: center;
      gap: 0.8em;
      margin-left: 0.5em;
    }
    .stockitem-rule-inputs .stockitem-arrow {
      color: #9ca3af;
      font-weight: 700;
      font-size: 1rem;
    }
    
    /* モバイル表示時のストック品リスト調整 */
    @media (max-width: 600px) {
      #stockitem-list li {
        flex-direction: column;
        align-items: flex-start;
        gap: 1em;
        padding: 1em;
      }
      .stockitem-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8em;
        width: 100%;
      }
      .stockitem-rule {
        flex-wrap: wrap;
        gap: 0.5em;
        margin-left: 0;
      }
      .stockitem-name {
        font-size: 1.1rem;
        padding: 0.2em 0.6em;
      }
      .stockitem-rule {
        font-size: 1rem;
      }
      .stockitem-threshold,
      .stockitem-buyamount {
        font-size: 0.9rem;
      }
      .stockitem-edit-buttons {
        width: 100%;
        flex-direction: row;
        justify-content: flex-start;
        margin-left: 0;
        margin-top: 0.5em;
      }
      .stockitem-edit-btn,
      .stockitem-save-btn,
      .stockitem-cancel-btn {
        width: 38px !important;
        height: 38px !important;
      }
      .stockitem-edit-btn svg,
      .stockitem-save-btn svg,
      .stockitem-cancel-btn svg {
        width: 20px;
        height: 20px;
      }
      /* 編集モード時のモバイル調整 */
      .stockitem-edit-mode .stockitem-threshold,
      .stockitem-edit-mode .stockitem-buyamount {
        width: 2.5em !important;
      }
    }

    #add-task-section, #task-list-section, #history-section {
      border-width: 2.2px !important;
      border-style: solid !important;
      border-color: #222 !important;
    }

    .member-actions {
      display: flex;
      align-items: center;
      gap: 0.7em;
    }

    #welcome-guide {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,224,0.98);
      align-items: center;
      justify-content: center;
    }
    #welcome-guide > div {
      background: #fffbe7;
      border: 2.2px solid #222;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      padding: 2.5rem 2rem;
      max-width: 95vw;
      width: 400px;
      text-align: center;
    }

    .self-set-btn,
    .self-indicator-badge {
      border-radius: 16px !important;
      width: 7em !important;      /* ← 幅を固定（お好みで調整可） */
      font-size: 0.97rem !important;
      padding: 0.3em 0 !important; /* 横paddingは0でOK */
      font-weight: 600 !important;
      text-align: center;
      box-sizing: border-box;
      vertical-align: middle;
      display: inline-block;
    }

    /* タスクリストの各行を中央寄せ */
    #task-list li {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.2em;
    }
    /* 各行の中身も中央寄せ */
    .task-info, .task-row-info, .task-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.7em;
    }
    /* ボタン内のアイコンを中央に */
    .task-edit-btn, .delete-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.3em 0.7em;
    }
    /* SVGアイコンの大きさ統一 */
    .task-edit-btn svg,
    .delete-btn svg {
      width: 20px;
      height: 20px;
      display: block;
    }
    /* 削除ボタンの大きさを編集ボタンと揃える */
    .delete-btn {
      padding: 0.3em 0.7em;
      min-width: unset;
      height: auto;
    }

    /* Google Fontsの読み込み */
    @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique:wght@700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap');

    /* タスクリストカードレイアウト */
    #task-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.2rem 2.2rem;
      padding: 1.5em 0 1.5em 0;
    }
    @media (max-width: 900px) {
      #task-list {
        grid-template-columns: 1fr;
        gap: 1.2rem 0;
      }
    }
    #task-list li {
      background: #ebebeb;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      border: none;
      padding: 2.2em 2em 1.5em 2em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      min-height: 210px;
      position: relative;
      margin: 0;
    }
    .task-card-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 0.7em;
    }
    .task-title {
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 900;
      font-size: 2.1rem;
      color: #222;
      letter-spacing: 0.04em;
      line-height: 1.15;
      word-break: break-all;
      margin-bottom: 0.1em;
      margin-right: 0.5em;
      flex: 1 1 auto;
      display: block;
    }
    .task-amount-block {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      justify-content: flex-end;
      min-width: 2.5em;
      height: 100%;
      gap: 0.2em;
    }
    .task-amount {
      font-family: 'Montserrat', 'Futura', 'Arial', sans-serif !important;
      font-weight: 500 !important;
      font-size: 2.7rem;
      color: #222;
      line-height: 1;
      margin-bottom: 0;
      text-align: right;
      display: block;
    }
    .task-amount-unit {
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif !important;
      font-weight: 900 !important;
      font-size: 1.3rem;
      color: #222;
      margin-left: 0.1em;
      line-height: 1;
      text-align: right;
      display: block;
      margin-bottom: 0.2em;
    }
    .task-note {
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: #222;
      margin-bottom: 0.7em;
      margin-top: 0.2em;
      word-break: break-all;
      width: 100%;
    }
    .task-note-row {
      display: flex;
      align-items: center;
      gap: 1.2em;
      margin-bottom: 1.1em;
      width: 100%;
    }
    .task-member-label {
      font-size: 1.1rem;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif !important;
      font-weight: 900 !important;
      margin-right: 0.3em;
      color: #222;
      display: none;
    }
    .task-member-name {
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif !important;
      font-weight: 700 !important;
      font-size: 1.1rem;
      background: #f87171;
      color: #fff;
      border-radius: 999px;
      padding: 0.2em 1.3em;
      margin-right: 0.7em;
      display: inline-block;
      border: none;
      vertical-align: middle;
      min-width: 3.5em;
      text-align: center;
    }
    .task-actions {
      display: flex;
      align-items: center;
      gap: 1.1em;
      margin-top: auto;
      width: 100%;
      justify-content: flex-end;
    }
    .task-edit-btn, .delete-btn, .complete-btn {
      border-radius: 999px;
      border: none;
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      padding: 0;
      box-shadow: none;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      cursor: pointer;
    }
    .task-edit-btn {
      background: #60a5fa;
      color: #fff;
    }
    .task-edit-btn:hover {
      background: #2563eb;
    }
    .delete-btn {
      background: #f87171;
      color: #fff;
    }
    .delete-btn:hover {
      background: #dc2626;
    }
    .complete-btn {
      background: #fde047;
      color: #222;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif !important;
      font-weight: 900 !important;
      width: auto;
      min-width: 70px;
      height: 44px;
      padding: 0 1.3em;
      border-radius: 999px;
      font-size: 1.1rem;
      border: 2.2px solid #222;
    }
    .complete-btn:hover {
      background: #facc15;
    }
    .task-edit-btn svg, .delete-btn svg {
      width: 24px;
      height: 24px;
      display: block;
      margin: auto;
    }
    @media (max-width: 900px) {
      #task-list li {
        padding: 1.2em 1em 1em 1em;
      }
      .task-title {
        font-size: 1.3rem;
      }
      .task-amount {
        font-size: 2rem;
      }
      .task-amount-unit {
        font-size: 1.1rem;
      }
      .complete-btn {
        min-width: 54px;
        height: 38px;
        font-size: 1rem;
        padding: 0 0.7em;
      }
      .task-edit-btn, .delete-btn {
        width: 38px;
        height: 38px;
      }
      .task-edit-btn svg, .delete-btn svg {
        width: 20px;
        height: 20px;
      }
    }

    .task-list-section-custom {
      background: #fff;
      border: none;
      border-top: 3px solid #222;
      box-shadow: none;
      max-width: 1200px;
      margin: 8em auto 8em auto;
      padding: 2.5em 0 2em 0;
      position: relative;
      border-radius: 0 16px 16px 16px;
    }
    .section-tab-title {
      position: absolute;
      top: -1.85em;
      left: -0.05em;
      background: #ffe066;
      color: #222;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 900;
      font-size: 2.5rem;
      border-radius: 14px 14px 0 0;
      /*border: 2.2px solid #222;*/
      border-bottom: none;
      padding: 0.25em 1.5em 0.15em 1.5em;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      letter-spacing: 0.04em;
      display: inline-block;
    }
    #task-list {
      max-width: 1100px;
      margin: 0 auto;
    }
    #task-list li {
      background: #e5e5e5;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      border: none;
      padding: 2.2em 2em 1.5em 2em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      min-height: 210px;
      position: relative;
      margin: 0;
    }
    .task-actions {
      display: flex;
      align-items: center;
      gap: 1.1em;
      margin-top: auto;
      width: 100%;
      justify-content: flex-start;
    }
    .task-actions .task-member-name {
      margin-right: 1.1em;
      margin-left: 0;
    }
    @media (max-width: 900px) {
      .section-tab-title {
        font-size: 1.4rem;
        padding: 0.18em 1em 0.1em 1em;
        left: 0.7em;
        top: -1.2em;
      }
      .task-list-section-custom {
        margin-top: 6em;
        margin-bottom: 7em;
        padding-top: 2em;
      }
    }
    
    /* --- 履歴セクションのカスタムスタイル --- */
    .history-section-custom {
      background: #fff;
      border: none;
      border-top: 3px solid #222;
      box-shadow: none;
      max-width: 1200px;
      margin: 6em auto 8em auto;
      padding: 2.5em 0 2em 0;
      position: relative;
      border-radius: 0 16px 16px 16px;
    }
    
    /* --- 在庫更新セクションのカスタムスタイル --- */
    .stock-update-section-custom {
      background: #fff;
      border: none;
      border-top: 3px solid #222;
      box-shadow: none;
      max-width: 1200px;
      margin: 6em auto 8em auto;
      padding: 2.5em 0 2em 0;
      position: relative;
      border-radius: 0 16px 16px 16px;
    }
    
    /* 履歴リストと在庫リストのスタイル調整 */
    #history-list, #stock-list {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 2em;
    }
    
    @media (max-width: 900px) {
      .history-section-custom,
      .stock-update-section-custom {
        margin-top: 5em;
        margin-bottom: 7em;
        padding-top: 2em;
      }
      #history-list, #stock-list {
        padding: 0 1em;
      }
    }
    
    /* タスク追加フォームとタブの重なり防止 */
    #add-task-section {
      margin-bottom: 3.5em;
    }

    /* --- タスク追加セクションのカスタムスタイル --- */
    .add-task-section-custom {
      background: #fff;
      border: none;
      border-top: 3px solid #222;
      box-shadow: none;
      max-width: 1200px;
      margin: 8em auto 10em auto;
      padding: 2.5em 0 2em 0;
      position: relative;
      border-radius: 0 16px 16px 16px;
    }
    #add-task-form {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 1.2em;
      align-items: flex-end;
      padding: 0 2em;
    }
    #add-task-form input[type="text"],
    #add-task-form input[type="number"] {
      flex: 2 1 220px;
      min-width: 140px;
      max-width: 340px;
      border-radius: 12px;
      border: 2.2px solid #222;
      background: #fffbe7;
      padding: 0.8em 1.2em;
      font-size: 1.1rem;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      color: #222;
      transition: border 0.2s, background 0.2s;
      text-align: left;
      box-sizing: border-box;
    }
    #add-task-form input[type="text"]::placeholder,
    #add-task-form input[type="number"]::placeholder {
      text-align: left;
    }
    #item-note {
      min-width: unset !important;
      max-width: unset !important;
      width: 100%;
    }
    #add-task-form input[type="text"]:focus {
      border: 2.2px solid #ffe066;
      outline: none;
      background: #fff;
    }
    #add-task-form input[type="number"]:focus {
      border: 2.2px solid #ffe066;
      outline: none;
      background: #fff;
    }
    #add-task-form input::placeholder {
      color: #aaa;
      font-weight: 600;
    }
    #add-task-form button[type="submit"] {
      max-width: 120px;
      width: auto;
      margin-left: auto;
      margin-right: 10px;
      border-radius: 12px;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      font-weight: 900;
      font-size: 1.1rem;
      padding: 0.8em 2em;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
      display: block;
    }
    #add-task-form button[type="submit"]:hover {
      background: #fffbe7;
      transform: translateY(-1px) scale(1.04);
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.18), 0 1.5px 0 #ffe066;
    }
    @media (max-width: 900px) {
      .add-task-section-custom {
        margin-top: 6em;
        margin-bottom: 8em;
        padding-top: 2em;
      }
      #add-task-form {
        flex-direction: column;
        gap: 0.8em;
        padding: 0 1em;
      }
      #add-task-form input[type="text"],
      #add-task-form input[type="number"] {
        flex: none;
        width: 100%;
        max-width: none;
      }
      #add-task-form button[type="submit"] {
        width: 100%;
        margin-top: 0.5em;
      }
    }
    /* タスク追加セクションの入力欄とボタンの高さ統一 */
    #add-task-form input[type="text"],
    #add-task-form input[type="number"],
    #add-task-form button[type="submit"] {
      height: 48px;
      font-size: 1.1rem;
      line-height: 1.1;
      padding: 0.8em 1.2em;
      box-sizing: border-box;
      vertical-align: middle;
      border-radius: 12px;
      display: inline-block;
    }
    #add-task-form input[type="text"],
    #add-task-form input[type="number"] {
      margin-bottom: 0;
    }
    #add-task-form button[type="submit"] {
      min-width: 100px;
      font-weight: 900;
      font-family: 'Zen Kaku Gothic Antique', 'Noto Sans JP', sans-serif;
      cursor: pointer;
    }

    .add-task-section-custom,
    .task-list-section-custom,
    .history-section-custom,
    .stock-update-section-custom {
      padding: 2.5em 0 2em 0;
    }

    /* 各セクションの外側に余白をつけるラッパー */
    @media (max-width: 1200px) {
      .section-outer-wrap {
        padding-left: 24px;
        padding-right: 24px;
        box-sizing: border-box;
      }
    }
    @media (max-width: 900px) {
      .section-outer-wrap {
        padding-left: 10px;
        padding-right: 10px;
      }
      .section-tab-title {
        position: absolute;
        top: -2.6em;
        left: -0.1em;
        display: inline-block;
        width: fit-content;
        font-size: 1.5rem;
        padding: 0.6em 1.5em;
        margin-bottom: 1.2em;
        border-radius: 12px 12px 0 0;
        box-sizing: border-box;
        background: #ffe066;
        color: #222;
        font-weight: 900;
        letter-spacing: 0.04em;
      }
      .add-task-section-custom,
      .task-list-section-custom,
      .history-section-custom,
      .stock-update-section-custom {
        margin: 2em auto 2em auto;
      }
    }
    @media (max-width: 900px) {
      .section-tab-title {
        margin-top: 0em;
      }
    }
    @media (max-width: 600px) {
      .section-tab-title {
        margin-top: 0em;
      }
    }
    @media (max-width: 900px) {
      section {
        margin-top: 5em !important;
      }
    }
    @media (max-width: 600px) {
      section {
        margin-top: 5em !important;
      }
    }
    @media (max-width: 900px) {
      h1 {
        font-size: 1.3rem;
        padding: 0.15em 0.7em;
        letter-spacing: 0.04em;
      }
      header > div {
        display: flex;
        flex-direction: row;
        gap: 0.5em;
        align-items: center;
      }
      header .header-btn {
        margin-left: 0.5em;
        margin-top: 0;
        margin-bottom: 0;
      }
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.2rem;
        padding: 0.1em 0.5em;
        letter-spacing: 0.03em;
      }
      header > div {
        display: flex;
        flex-direction: row;
        gap: 0.3em;
        align-items: center;
      }
      header .header-btn {
        margin-left: 0.3em;
        margin-top: 0;
        margin-bottom: 0;
      }
    }
    @media (max-width: 900px) {
      #task-list li {
        margin-left: 20px;
        margin-right: 20px;
        margin-bottom: 1.2em;
      }
    }
    @media (max-width: 600px) {
      #task-list li {
        margin-left: 20px;
        margin-right: 20px;
        margin-bottom: 1em;
      }
    }

    #task-list li {
      margin-left: 20px;
      margin-right: 20px;
      margin-bottom: 1.5em;
    }

    /* --- 担当者選択バッジの折り返し --- */
    .member-badge-select-wrap {
      display: flex;
      flex-wrap: wrap;
      max-width: 100%;
      gap: 0.5em;
      margin-top: 0.5em;
    }

    @media (max-width: 900px) {
      .modal-content {
        margin-left: 16px;
        margin-right: 16px;
        width: auto;
        min-width: 400px;
        box-sizing: border-box;
      }
    }
    @media (max-width: 600px) {
      .modal-content {
        margin-left: 8px;
        margin-right: 8px;
      }
    }

    .task-actions {
      flex-direction: row !important;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      gap: 1.1em;
    }
    .member-badge-select-wrap {
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      max-width: 100%;
      gap: 0.3em;
      margin-top: 0.5em;
    }
    .task-member-name, .member-badge {
      white-space: nowrap;
    }
    .history-member, .history-member-total {
      white-space: nowrap;
    }
    .history-member-totals {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em;
      align-items: center;
      margin-top: 1em;
      margin-bottom: 0.5em;
    }
    @media (max-width: 900px) {
      .history-member-totals {
        gap: 0.4em;
        justify-content: flex-start;
      }
      .history-member-total {
        margin-bottom: 0.3em;
      }
    }
    @media (max-width: 600px) {
      .history-member-totals {
        gap: 0.2em;
        justify-content: flex-start;
      }
      .history-member-total {
        margin-bottom: 0.2em;
      }
    }

    body.dark section,
    body.dark .task-list-section-custom,
    body.dark .add-task-section-custom,
    body.dark .history-section-custom,
    body.dark .stock-update-section-custom,
    body.dark input,
    body.dark button,
    body.dark .modal-content {
      border-color: #ffe066 !important;
    }
    body.dark #task-list li,
    body.dark .stock-item,
    body.dark .history-item {
      border-color: #ffe066 !important;
    }

    body.dark #add-task-section,
    body.dark #task-list-section,
    body.dark #history-section {
      border-color: #ffe066 !important;
    }

    body.dark .stock-item,
    body.dark .stock-item input,
    body.dark .stock-item span,
    body.dark .stock-item strong {
      color: #000000 !important;
    }
  </style>
</head>
<body>
  <!-- 初回アクセス時のウェルカムガイド -->
  <div id="welcome-guide" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100vw; height:100vh; background:rgba(255,255,224,0.98); display:flex; align-items:center; justify-content:center;">
    <div style="background:#fffbe7; border:2.2px solid #222; border-radius:18px; box-shadow:0 4px 24px rgba(0,0,0,0.10); padding:2.5rem 2rem; max-width:95vw; width:400px; text-align:center;">
      <h2 style="margin-bottom:1.2em;">はじめに設定が必要です</h2>
      <p style="font-size:1.1em; margin-bottom:1.5em;">このアプリを使うには、<b>住民リスト</b>と<b>ストック品リスト</b>の登録が必要です。<br>まずは設定を行ってください。</p>
      <button id="start-setup-btn" style="background:#ffe066; color:#222; border:2.2px solid #222; border-radius:12px; font-size:1.1em; font-weight:700; padding:0.7em 2.2em; cursor:pointer;">設定を始める</button>
    </div>
  </div>

  <header>
    <h1>買い出し Todo</h1>
    <div>
      <button id="theme-toggle" class="header-btn" title="ライト/ダーク切替">
        <span id="theme-icon" style="font-size:1.2em;vertical-align:middle;">🌙</span>
        <span>ライト/ダーク</span>
      </button>
      <button id="settings-btn" class="header-btn" title="設定">
        <span style="font-size:1.2em;vertical-align:middle;">⚙️</span>
        <span>設定</span>
      </button>
    </div>
  </header>

  <div class="section-outer-wrap">
    <section id="add-task-section" class="add-task-section-custom">
      <div class="section-tab-title">タスク追加</div>
      <form id="add-task-form">
        <input type="text" id="item-name" placeholder="商品名" required>
        <input type="number" id="item-stock" placeholder="買う個数" min="0" required>
        <input type="text" id="item-note" placeholder="備考（例：ふわふわのやつで）" style="min-width:120px;max-width:220px;">
        <button type="submit">追加</button>
      </form>
    </section>

    <section id="task-list-section" class="task-list-section-custom" style="position:relative;">
      <div class="section-tab-title">買い物タスクリスト</div>
      <ul id="task-list">
        <!-- タスクがここに表示されます -->
      </ul>
    </section>

    <section id="history-section" class="history-section-custom">
      <div class="section-tab-title">買い物履歴</div>
      <ul id="history-list">
        <!-- 買い物履歴がここに表示されます -->
      </ul>
    </section>

    <section id="stock-update-section" class="stock-update-section-custom">
      <div class="section-tab-title">在庫数の更新</div>
      <div id="stock-list">
        <!-- 在庫品リストがここに表示されます -->
      </div>
    </section>
  </div>

  <!-- 基本設定モーダル -->
  <div id="settings-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>基本設定</h2>
      <div class="settings-tabs">
        <button type="button" id="tab-member" class="tab-btn active">住人リスト</button>
        <button type="button" id="tab-stock" class="tab-btn">ストック品リスト</button>
      </div>
      <form id="settings-form">
        <section id="member-section">
          <ul id="member-list"></ul>
          <input type="text" id="new-member" placeholder="住民名">
          <button type="button" id="add-member">追加</button>
        </section>
        <section id="stockitem-section" style="display:none;">
          <ul id="stockitem-list"></ul>
          <div class="stockitem-add-form">
            <input type="text" id="new-stockitem" placeholder="品名">
            <div class="stockitem-rule-inputs">
              <input type="number" id="new-threshold" placeholder="残り何個で" min="1" style="width:6em;">
              <span class="stockitem-arrow">→</span>
              <input type="number" id="new-buyamount" placeholder="何個買う" min="1" style="width:6em;">
            </div>
            <button type="button" id="add-stockitem">追加</button>
          </div>
        </section>
        <div style="margin-top:1em; text-align:right;">
          <button type="button" id="settings-cancel">キャンセル</button>
          <button type="submit" id="settings-save">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 購入金額入力モーダル -->
  <div id="price-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>購入完了</h2>
      <div style="margin-bottom:1.5em;">
        <p style="margin-bottom:1em; font-size:1.1em;"><strong id="price-item-name"></strong> の購入が完了しました。</p>
        <p style="margin-bottom:1.5em; color:#666;">購入金額を入力してください：</p>
        <div style="display:flex; align-items:center; gap:0.5em;">
          <input type="number" id="purchase-price" placeholder="金額" min="0" style="width:8em; text-align:right;">
          <span style="font-weight:700;">円</span>
        </div>
      </div>
      <div style="text-align:right;">
        <button type="button" id="price-cancel" style="margin-right:0.5em;">キャンセル</button>
        <button type="button" id="price-confirm">完了</button>
      </div>
    </div>
  </div>

  <script>
    // ここにJavaScriptを後で追加します
    // テーマ切替
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;
    // ローカルストレージからテーマを復元
    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark');
      if(themeIcon) themeIcon.textContent = '☀️';
    }
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark');
      localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
      if(themeIcon) themeIcon.textContent = body.classList.contains('dark') ? '☀️' : '🌙';
    });

    // === 基本設定画面ロジック ===
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsForm = document.getElementById('settings-form');
    const memberList = document.getElementById('member-list');
    const newMemberInput = document.getElementById('new-member');
    const addMemberBtn = document.getElementById('add-member');
    const stockitemList = document.getElementById('stockitem-list');
    const newStockitemInput = document.getElementById('new-stockitem');
    const newThresholdInput = document.getElementById('new-threshold');
    const newBuyamountInput = document.getElementById('new-buyamount');
    const addStockitemBtn = document.getElementById('add-stockitem');
    const settingsCancelBtn = document.getElementById('settings-cancel');

    // 設定データ
    function getSettings() {
      // 住人は{name, color}形式で管理
      return JSON.parse(localStorage.getItem('settings') || '{"members":[],"stockItems":[],"selfMember":""}');
    }
    function saveSettings(settings) {
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    // デフォルトカラーリスト
    const defaultColors = [
      '#10b981', // グリーン
      '#6366f1', // ブルー
      '#f59e42', // オレンジ
      '#f43f5e', // ピンク
      '#fbbf24', // イエロー
      '#0ea5e9', // 水色
      '#a21caf', // パープル
      '#64748b'  // グレー
    ];

    // 設定画面の表示・非表示
    function openSettings() {
      // 現在の設定を取得
      const settings = getSettings();
      // 住人リスト描画
      memberList.innerHTML = '';
      settings.members.forEach((member, idx) => {
        const li = document.createElement('li');

        // 名前
        const nameWrap = document.createElement('span');
        nameWrap.className = 'member-name-label';
        nameWrap.textContent = member.name ? member.name : '';
        li.appendChild(nameWrap);

        // カラーピッカー
        const colorWrap = document.createElement('span');
        colorWrap.className = 'color-picker-wrap';
        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = member.color || defaultColors[idx % defaultColors.length];
        colorInput.className = 'color-circle-picker';
        colorInput.oninput = (e) => {
          settings.members[idx].color = e.target.value;
          saveSettings(settings);
        };
        colorWrap.appendChild(colorInput);
        li.appendChild(colorWrap);

        // ボタン類をラップ
        const actions = document.createElement('span');
        actions.className = 'member-actions';

        // 自分バッジor自分にするボタン
        if (member.name === settings.selfMember) {
          const selfBadge = document.createElement('span');
          selfBadge.className = 'self-indicator-badge';
          selfBadge.textContent = '自分';
          actions.appendChild(selfBadge);
        } else {
          const selfBtn = document.createElement('button');
          selfBtn.textContent = '自分にする';
          selfBtn.className = 'self-set-btn';
          selfBtn.onclick = () => {
            settings.selfMember = member.name;
            saveSettings(settings);
            openSettings();
          };
          actions.appendChild(selfBtn);
        }

        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.textContent = '削除';
        delBtn.className = 'delete-btn';
        delBtn.onclick = () => {
          if (member.name === settings.selfMember) {
            settings.selfMember = '';
          }
          settings.members.splice(idx, 1);
          saveSettings(settings);
          openSettings();
        };
        actions.appendChild(delBtn);

        li.appendChild(actions);
        memberList.appendChild(li);
      });
      // ストック品リスト描画
      stockitemList.innerHTML = '';
      settings.stockItems.forEach((item, idx) => {
        const li = document.createElement('li');
        
        // ストック品情報エリア
        const infoDiv = document.createElement('div');
        infoDiv.className = 'stockitem-info';
        
        // 品名
        const nameSpan = document.createElement('span');
        nameSpan.className = 'stockitem-name';
        nameSpan.textContent = item.name;
        
        // ルール表示
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'stockitem-rule';
        
        const thresholdSpan = document.createElement('span');
        thresholdSpan.className = 'stockitem-threshold';
        thresholdSpan.textContent = `${item.threshold}個以下`;
        
        const arrowSpan = document.createElement('span');
        arrowSpan.className = 'stockitem-arrow';
        arrowSpan.textContent = '→';
        
        const buyamountSpan = document.createElement('span');
        buyamountSpan.className = 'stockitem-buyamount';
        buyamountSpan.textContent = `${item.buyAmount}個買う`;
        
        ruleDiv.appendChild(thresholdSpan);
        ruleDiv.appendChild(arrowSpan);
        ruleDiv.appendChild(buyamountSpan);
        
        infoDiv.appendChild(nameSpan);
        infoDiv.appendChild(ruleDiv);
        
        // ボタンエリア
        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'stockitem-edit-buttons';
        
        // 編集ボタン
        const editBtn = document.createElement('button');
        editBtn.title = '編集';
        editBtn.className = 'stockitem-edit-btn';
        editBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12.44 3.78006L2.19796 14.0201C1.89343 14.3245 1.69528 14.719 1.63296 15.1451L1.07996 18.9191L4.85496 18.3661C5.28112 18.3035 5.67569 18.1049 5.97996 17.8001L16.22 7.56006M12.44 3.78006L14.669 1.55006C14.8175 1.40144 14.9939 1.28356 15.1881 1.20313C15.3822 1.1227 15.5903 1.0813 15.8005 1.0813C16.0106 1.0813 16.2187 1.1227 16.4128 1.20313C16.607 1.28356 16.7834 1.40144 16.932 1.55006L18.45 3.06806C18.5986 3.21664 18.7165 3.39303 18.7969 3.58718C18.8773 3.78132 18.9187 3.98941 18.9187 4.19956C18.9187 4.4097 18.8773 4.61779 18.7969 4.81193C18.7165 5.00608 18.5986 5.18248 18.45 5.33106L16.22 7.56006M12.44 3.78006L16.22 7.56006" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        `;
        editBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          // 編集モードに切り替え
          li.classList.add('stockitem-edit-mode');
          
          // 品名を入力フィールドに変更
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.value = item.name;
          nameInput.className = 'stockitem-name';
          nameSpan.replaceWith(nameInput);
          
          // 閾値を入力フィールドに変更
          const thresholdInput = document.createElement('input');
          thresholdInput.type = 'number';
          thresholdInput.value = item.threshold;
          thresholdInput.min = 1;
          thresholdInput.className = 'stockitem-threshold';
          thresholdSpan.replaceWith(thresholdInput);
          
          // 購入数を入力フィールドに変更
          const buyamountInput = document.createElement('input');
          buyamountInput.type = 'number';
          buyamountInput.value = item.buyAmount;
          buyamountInput.min = 1;
          buyamountInput.className = 'stockitem-buyamount';
          buyamountSpan.replaceWith(buyamountInput);
          
          // ボタンを保存・キャンセルに変更
          editBtn.remove();
          delBtn.remove();
          
          const saveBtn = document.createElement('button');
          saveBtn.textContent = '保存';
          saveBtn.className = 'stockitem-save-btn';
          saveBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            // 値を更新
            item.name = nameInput.value.trim();
            item.threshold = parseInt(thresholdInput.value, 10);
            item.buyAmount = parseInt(buyamountInput.value, 10);
            
            // バリデーション
            if (!item.name || isNaN(item.threshold) || isNaN(item.buyAmount) || item.threshold < 1 || item.buyAmount < 1) {
              alert('正しい値を入力してください。');
              return;
            }
            
            saveSettings(settings);
            openSettings(); // 再描画
          };
          
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'キャンセル';
          cancelBtn.className = 'stockitem-cancel-btn';
          cancelBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            openSettings(); // 再描画して元に戻す
          };
          
          buttonDiv.appendChild(saveBtn);
          buttonDiv.appendChild(cancelBtn);
        };
        
        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.title = '削除';
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 7L14.16 15.398C14.033 16.671 13.97 17.307 13.68 17.788C13.4257 18.2114 13.0516 18.55 12.605 18.761C12.098 19 11.46 19 10.18 19H7.82C6.541 19 5.902 19 5.395 18.76C4.94805 18.5491 4.57361 18.2106 4.319 17.787C4.031 17.307 3.967 16.671 3.839 15.398L3 7M10.5 13.5V8.5M7.5 13.5V8.5M1.5 4.5H6.115M6.115 4.5L6.501 1.828C6.613 1.342 7.017 1 7.481 1H10.519C10.983 1 11.386 1.342 11.499 1.828L11.885 4.5M6.115 4.5H11.885M11.885 4.5H16.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        `;
        delBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          settings.stockItems.splice(idx, 1);
          saveSettings(settings);
          openSettings();
        };
        
        buttonDiv.appendChild(editBtn);
        buttonDiv.appendChild(delBtn);
        
        li.appendChild(infoDiv);
        li.appendChild(buttonDiv);
        stockitemList.appendChild(li);
      });
      // 入力欄リセット
      newMemberInput.value = '';
      newStockitemInput.value = '';
      newThresholdInput.value = '';
      newBuyamountInput.value = '';
      settingsModal.style.display = 'flex';
    }
    function closeSettings() {
      settingsModal.style.display = 'none';
    }

    // 設定ボタンで開く
    settingsBtn.addEventListener('click', openSettings);
    // キャンセルで閉じる
    settingsCancelBtn.addEventListener('click', (e) => {
      e.preventDefault();
      closeSettings();
    });
    // 住民追加
    addMemberBtn.addEventListener('click', () => {
      const name = newMemberInput.value.trim();
      if (!name) return;
      const settings = getSettings();
      if (!settings.members.some(m => m.name === name)) {
        // 新規住人にはデフォルト色を割り当て
        const color = defaultColors[settings.members.length % defaultColors.length];
        settings.members.push({ name, color });
        saveSettings(settings);
        openSettings();
      }
    });
    // 住民名入力欄でエンターキーでも追加できるように
    newMemberInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) {
        e.preventDefault();
        addMemberBtn.click();
      }
    });
    // ストック品追加
    addStockitemBtn.addEventListener('click', () => {
      const name = newStockitemInput.value.trim();
      const threshold = parseInt(newThresholdInput.value, 10);
      const buyAmount = parseInt(newBuyamountInput.value, 10);
      if (!name || isNaN(threshold) || isNaN(buyAmount)) return;
      const settings = getSettings();
      if (!settings.stockItems.some(item => item.name === name)) {
        settings.stockItems.push({ name, threshold, buyAmount });
        saveSettings(settings);
        openSettings();
      }
    });
    // 設定保存
    settingsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // 自分が設定されているかチェック
      const settings = getSettings();
      if (!settings.selfMember) {
        alert('必ず住民リストから自分を設定してください。');
        return;
      }
      
      closeSettings();
      // 設定内容をアプリに反映
      applySettings();
    });

    // === 初回アクセス時ウェルカムガイド ===
    const welcomeGuide = document.getElementById('welcome-guide');
    const startSetupBtn = document.getElementById('start-setup-btn');

    // 初回アクセス時は設定画面を自動表示 → ウェルカムガイドに変更
    window.addEventListener('DOMContentLoaded', () => {
      const settings = getSettings();
      if (!settings.members.length || !settings.stockItems.length || !settings.selfMember) {
        // ウェルカムガイド表示
        if (welcomeGuide) welcomeGuide.style.display = 'flex';
      } else {
        if (welcomeGuide) welcomeGuide.style.display = 'none';
        applySettings();
      }
    });

    // 「設定を始める」ボタンで設定モーダルを開く
    if (startSetupBtn) {
      startSetupBtn.addEventListener('click', () => {
        if (welcomeGuide) welcomeGuide.style.display = 'none';
        openSettings();
      });
    }

    // 設定保存時、設定が完了していればウェルカムガイドを非表示
    settingsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const settings = getSettings();
      if (!settings.selfMember) {
        alert('必ず住民リストから自分を設定してください。');
        return;
      }
      if (welcomeGuide) welcomeGuide.style.display = 'none';
      closeSettings();
      applySettings();
    });

    // 設定内容をアプリに反映
    let members = [];
    let selfMember = '';
    let stockItems = [];
    
    function applySettings() {
      const settings = getSettings();
      members = settings.members.slice();
      selfMember = settings.selfMember;
      stockItems = settings.stockItems.slice();
      
      renderTasks();
      renderHistory();
      renderStockList();
    }

    // モーダル外クリックで閉じないように（必要なら追加）
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) closeSettings();
    });

    // === タスク管理 ===
    // タスクデータ構造: { name, stock, member, done, completedAt }
    let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    let history = JSON.parse(localStorage.getItem('history') || '[]');

    const addTaskForm = document.getElementById('add-task-form');
    const itemNameInput = document.getElementById('item-name');
    const itemStockInput = document.getElementById('item-stock');
    const itemNoteInput = document.getElementById('item-note');
    const taskList = document.getElementById('task-list');
    const historyList = document.getElementById('history-list');

    // タスクリスト表示を修正（各タスクに買います宣言ボタンを追加）
    function renderTasks() {
      taskList.innerHTML = '';
      const settings = getSettings();
      tasks.forEach((task, idx) => {
        if (task.done) return;
        const li = document.createElement('li');
        const info = document.createElement('div');
        info.className = 'task-info';

        // 編集モード判定
        const isEditing = task.editing;

        if (isEditing) {
          // 編集UI
          const editCard = document.createElement('div');
          editCard.className = 'task-edit-card';
          // 商品名
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.value = task.name;
          nameInput.placeholder = '商品名';
          // 買う個数
          const amountInput = document.createElement('input');
          amountInput.type = 'number';
          amountInput.value = task.stock;
          amountInput.min = 1;
          amountInput.style.width = '4em';
          // 備考
          const noteInput = document.createElement('input');
          noteInput.type = 'text';
          noteInput.value = task.note || '';
          noteInput.placeholder = '備考';
          noteInput.style.width = '12em';
          // 保存
          const saveBtn = document.createElement('button');
          saveBtn.className = 'task-edit-save';
          saveBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="14" height="12" rx="2" fill="#10b981"/><path d="M7 9h6M7 13h6" stroke="#fff"/></svg> 保存';
          saveBtn.onclick = () => {
            task.name = nameInput.value.trim();
            task.stock = parseInt(amountInput.value, 10);
            task.note = noteInput.value.trim();
            task.editing = false;
            saveTasks();
            renderTasks();
          };
          // キャンセル
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'task-edit-cancel';
          cancelBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="#e63946" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="8" stroke="#e63946" fill="#fff"/><path d="M7 7l6 6M13 7l-6 6" stroke="#e63946"/></svg> キャンセル';
          cancelBtn.onclick = () => {
            task.editing = false;
            renderTasks();
          };
          editCard.appendChild(nameInput);
          editCard.appendChild(amountInput);
          editCard.appendChild(noteInput);
          editCard.appendChild(saveBtn);
          editCard.appendChild(cancelBtn);
          info.appendChild(editCard);
        } else {
          // 通常表示
          // カード上部：商品名・個数
          const cardRow = document.createElement('div');
          cardRow.className = 'task-card-row';
          // 商品名
          const nameElem = document.createElement('span');
          nameElem.className = 'task-title';
          nameElem.textContent = task.name;
          // 個数（縦並び）
          const amountBlock = document.createElement('span');
          amountBlock.className = 'task-amount-block';
          amountBlock.innerHTML = `<span class=\"task-amount\">${task.stock}</span><span class=\"task-amount-unit\">個</span>`;
          cardRow.appendChild(nameElem);
          cardRow.appendChild(amountBlock);
          info.appendChild(cardRow);

          // 備考欄
          const noteElem = document.createElement('div');
          noteElem.className = 'task-note';
          noteElem.textContent = task.note ? `備考：${task.note}` : '備考：';
          info.appendChild(noteElem);
        }

        const actions = document.createElement('div');
        actions.className = 'task-actions';
        // 担当バッジを必ず表示
        let memberBadge;
        if (task.member) {
          const memberObj = settings.members.find(m => m.name === task.member);
          const memberColor = memberObj && memberObj.color ? memberObj.color : '#10b981';
          memberBadge = document.createElement('span');
          memberBadge.className = 'task-member-name';
          memberBadge.style.background = memberColor;
          memberBadge.textContent = task.member;
        } else {
          memberBadge = document.createElement('span');
          memberBadge.className = 'task-member-name undecided';
          memberBadge.textContent = '未定';
        }
        // 担当バッジクリックで担当編集
        memberBadge.style.cursor = 'pointer';
        memberBadge.title = '担当を変更';
        memberBadge.onclick = function(e) {
          e.stopPropagation();
          // すでに選択UIがあれば消す
          const oldWrap = actions.querySelector('.member-badge-select-wrap');
          if (oldWrap) { oldWrap.remove(); return; }
          const wrap = document.createElement('div');
          wrap.className = 'member-badge-select-wrap';
          // wrapのスタイルはCSSで調整
          settings.members.forEach(m => {
            if (task.member === m.name) return; // すでに担当なら表示しない
            const badge = document.createElement('span');
            badge.className = 'task-member-name';
            badge.textContent = m.name;
            badge.style.background = m.color || '#10b981';
            badge.style.cursor = 'pointer';
            badge.onclick = function(ev) {
              ev.stopPropagation();
              task.member = m.name;
              saveTasks();
              renderTasks();
            };
            wrap.appendChild(badge);
          });
          // wrapの外をクリックしたら消す
          setTimeout(() => {
            document.addEventListener('click', function handler(ev) {
              if (!wrap.contains(ev.target)) {
                wrap.remove();
                document.removeEventListener('click', handler);
              }
            });
          }, 10);
          actions.insertBefore(wrap, memberBadge.nextSibling);
        };
        actions.appendChild(memberBadge);
        // 編集ボタン
        if (!task.editing) {
          const editBtn = document.createElement('button');
          editBtn.title = '編集';
          editBtn.className = 'task-edit-btn';
          editBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.44 3.78006L2.19796 14.0201C1.89343 14.3245 1.69528 14.719 1.63296 15.1451L1.07996 18.9191L4.85496 18.3661C5.28112 18.3035 5.67569 18.1049 5.97996 17.8001L16.22 7.56006M12.44 3.78006L14.669 1.55006C14.8175 1.40144 14.9939 1.28356 15.1881 1.20313C15.3822 1.1227 15.5903 1.0813 15.8005 1.0813C16.0106 1.0813 16.2187 1.1227 16.4128 1.20313C16.607 1.28356 16.7834 1.40144 16.932 1.55006L18.45 3.06806C18.5986 3.21664 18.7165 3.39303 18.7969 3.58718C18.8773 3.78132 18.9187 3.98941 18.9187 4.19956C18.9187 4.4097 18.8773 4.61779 18.7969 4.81193C18.7165 5.00608 18.5986 5.18248 18.45 5.33106L16.22 7.56006M12.44 3.78006L16.22 7.56006" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          `;
          editBtn.onclick = () => {
            task.editing = true;
            renderTasks();
          };
          actions.appendChild(editBtn);
        }
        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.title = '削除';
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = `
        <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 7L14.16 15.398C14.033 16.671 13.97 17.307 13.68 17.788C13.4257 18.2114 13.0516 18.55 12.605 18.761C12.098 19 11.46 19 10.18 19H7.82C6.541 19 5.902 19 5.395 18.76C4.94805 18.5491 4.57361 18.2106 4.319 17.787C4.031 17.307 3.967 16.671 3.839 15.398L3 7M10.5 13.5V8.5M7.5 13.5V8.5M1.5 4.5H6.115M6.115 4.5L6.501 1.828C6.613 1.342 7.017 1 7.481 1H10.519C10.983 1 11.386 1.342 11.499 1.828L11.885 4.5M6.115 4.5H11.885M11.885 4.5H16.5" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        `;
        delBtn.onclick = () => {
          if (confirm('このタスクを削除しますか？')) {
            tasks.splice(idx, 1);
            saveTasks();
            renderTasks();
          }
        };
        actions.appendChild(delBtn);
        // 完了ボタン（自分が担当の場合のみ表示）
        if (!task.editing && task.member === selfMember) {
          const doneBtn = document.createElement('button');
          doneBtn.textContent = '完了';
          doneBtn.className = 'complete-btn';
          doneBtn.onclick = () => {
            openPriceModal(idx);
          };
          actions.appendChild(doneBtn);
        }
        li.appendChild(info);
        li.appendChild(actions);
        taskList.appendChild(li);
      });
    }

    // 履歴表示
    function renderHistory() {
      historyList.innerHTML = '';
      const settings = getSettings();
      const memberTotals = {};
      
      // 全員の初期化（0円で初期化）
      settings.members.forEach(member => {
        memberTotals[member.name] = 0;
      });
      
      history.slice(-10).reverse().forEach(item => {
        const li = document.createElement('li');
        li.className = 'history-item';
        const date = new Date(item.completedAt).toLocaleDateString('ja-JP', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // 購入者のカラーを取得
        const memberObj = settings.members.find(m => m.name === item.member);
        const memberColor = memberObj && memberObj.color ? memberObj.color : '#10b981';
        
        // 金額情報がある場合は合計に加算
        if (item.price) {
          memberTotals[item.member] = (memberTotals[item.member] || 0) + item.price;
        }
        
        // 金額表示のHTML
        const priceInfo = item.price ? `<span class="history-price">${item.price.toLocaleString()}円</span>` : '';
        
        li.innerHTML = `
          <div class="history-date">${date}</div>
          <div class="history-content">
            <strong>${item.name}</strong> を 
            <span class="history-member" style="background: ${memberColor};">${item.member}</span> 
            が購入完了
            ${priceInfo}
          </div>
        `;
        historyList.appendChild(li);
      });
      
      // 各人の合計金額を表示（全員分）
      if (settings.members.length > 0) {
        const memberTotalsLi = document.createElement('li');
        memberTotalsLi.className = 'history-member-totals';
        memberTotalsLi.innerHTML = '<div class="history-member-totals-title">人ごとの購入合計:</div>';
        
        settings.members.forEach(member => {
          const amount = memberTotals[member.name] || 0;
          const memberColor = member.color || '#10b981';
          
          const memberTotalDiv = document.createElement('div');
          memberTotalDiv.className = 'history-member-total';
          memberTotalDiv.innerHTML = `
            <span class="history-member" style="background: ${memberColor};">${member.name}</span>
            <span class="history-member-amount">${amount.toLocaleString()}円</span>
          `;
          memberTotalsLi.appendChild(memberTotalDiv);
        });
        
        historyList.appendChild(memberTotalsLi);
      }
    }

    // 購入金額入力モーダル関連
    const priceModal = document.getElementById('price-modal');
    const priceItemName = document.getElementById('price-item-name');
    const purchasePriceInput = document.getElementById('purchase-price');
    const priceCancelBtn = document.getElementById('price-cancel');
    const priceConfirmBtn = document.getElementById('price-confirm');
    let currentTaskIndex = -1;

    // 購入金額入力モーダルを開く
    function openPriceModal(taskIndex) {
      const task = tasks[taskIndex];
      currentTaskIndex = taskIndex;
      priceItemName.textContent = task.name;
      purchasePriceInput.value = '';
      priceModal.style.display = 'flex';
      purchasePriceInput.focus();
    }

    // 購入金額入力モーダルを閉じる
    function closePriceModal() {
      priceModal.style.display = 'none';
      currentTaskIndex = -1;
    }

    // 購入完了処理
    function completeTaskWithPrice(taskIndex, price) {
      const task = tasks[taskIndex];
      task.done = true;
      task.completedAt = new Date().toISOString();
      
      // 履歴に追加（金額情報付き）
      history.push({
        name: task.name,
        member: task.member,
        completedAt: task.completedAt,
        price: price
      });
      
      // 履歴は最新50件まで保持
      if (history.length > 50) {
        history = history.slice(-50);
      }
      
      saveTasks();
      saveHistory();
      renderTasks();
      renderHistory();
      closePriceModal();
    }

    // モーダルイベントリスナー
    priceCancelBtn.addEventListener('click', closePriceModal);
    priceConfirmBtn.addEventListener('click', () => {
      const price = parseInt(purchasePriceInput.value, 10);
      if (isNaN(price) || price < 0) {
        alert('正しい金額を入力してください。');
        return;
      }
      completeTaskWithPrice(currentTaskIndex, price);
    });

    // エンターキーで完了
    purchasePriceInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) {
        e.preventDefault();
        priceConfirmBtn.click();
      }
    });

    // モーダル外クリックで閉じる
    priceModal.addEventListener('click', (e) => {
      if (e.target === priceModal) closePriceModal();
    });

    // タスク完了（金額入力なしの場合は使用しない）
    function completeTask(taskIndex) {
      // この関数は使用しない（金額入力モーダルを使用）
    }

    // タスク保存
    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    // 履歴保存
    function saveHistory() {
      localStorage.setItem('history', JSON.stringify(history));
    }

    // タスク追加処理を修正
    addTaskForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const name = itemNameInput.value.trim();
      const stock = parseInt(itemStockInput.value, 10);
      const note = itemNoteInput.value.trim();
      if (!name || isNaN(stock)) return;
      if (!members.length) {
        alert('住民が登録されていません。設定画面から住民を追加してください。');
        return;
      }
      
      tasks.push({ name, stock, member: members.length ? members[Math.floor(Math.random() * members.length)].name : '', done: false, note });
      saveTasks();
      renderTasks();
      addTaskForm.reset();
    });

    // === 在庫数管理・自動タスク化 ===
    const stockList = document.getElementById('stock-list');

    // 在庫リスト表示
    function renderStockList() {
      stockList.innerHTML = '';
      
      // ストック品リストに従って表示
      stockItems.forEach(stockItem => {
        const name = stockItem.name;
        const threshold = stockItem.threshold;
        const buyAmount = stockItem.buyAmount;
        
        // 実際の在庫数を取得（ローカルストレージから）
        const actualStock = parseInt(localStorage.getItem(`stock_${name}`) || '0', 10);
        
        const div = document.createElement('div');
        div.className = 'stock-item';
        div.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5em;">
            <strong>${name}</strong>
            <span class="stock-badge">${threshold}個以下で${buyAmount}個買う</span>
          </div>
          <div class="stock-info-row">
            <span>在庫:</span>
            <input type='number' min='0' value='${actualStock}' class='stock-input' data-name='${name}' data-threshold='${threshold}' data-buyamount='${buyAmount}'>
            <span>個</span>
          </div>
        `;
        
        const input = div.querySelector('.stock-input');
        input.addEventListener('change', () => {
          const newStock = parseInt(input.value, 10);
          updateStock(name, newStock, threshold, buyAmount);
        });
        
        stockList.appendChild(div);
      });
    }

    // 在庫更新
    function updateStock(name, newStock, threshold, buyAmount) {
      // アニメーション効果
      const input = document.querySelector(`input[data-name="${name}"]`);
      const stockItem = input.closest('.stock-item');
      stockItem.classList.add('updated');
      input.classList.add('updated');
      setTimeout(() => {
        stockItem.classList.remove('updated');
        input.classList.remove('updated');
      }, 600);
      
      // 実際の在庫数をローカルストレージに保存
      localStorage.setItem(`stock_${name}`, newStock.toString());
      
      // 在庫が閾値以下なら自動タスク化
      if (newStock <= threshold) {
        const already = tasks.some(task => task.name === name && !task.done);
        if (!already) {
          // 購入すべき個数をタスクに追加
          tasks.push({ 
            name, 
            stock: buyAmount, // 購入すべき個数
            member: '', 
            done: false,
            note: `在庫${newStock}個のため購入`
          });
          saveTasks();
          renderTasks();
          
          // タスクが追加されたことをユーザーに通知
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fbbf24;
            color: #222;
            padding: 1em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
          `;
          notification.textContent = `${name}の在庫が${threshold}個以下になったため、${buyAmount}個の購入タスクを追加しました`;
          document.body.appendChild(notification);
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => document.body.removeChild(notification), 300);
          }, 3000);
        }
      } else {
        // 在庫が十分なら未完了タスクを削除
        const beforeCount = tasks.length;
        tasks = tasks.filter(task => !(task.name === name && !task.done));
        if (tasks.length < beforeCount) {
          saveTasks();
          renderTasks();
          // 削除されたことをユーザーに通知
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 1em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
          `;
          notification.textContent = `${name}の在庫が十分になったため、タスクを削除しました`;
          document.body.appendChild(notification);
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => document.body.removeChild(notification), 300);
          }, 3000);
        }
      }
    }

    // タブ切り替えロジック
    document.addEventListener('DOMContentLoaded', function() {
      const tabMember = document.getElementById('tab-member');
      const tabStock = document.getElementById('tab-stock');
      const memberSection = document.getElementById('member-section');
      const stockSection = document.getElementById('stockitem-section');
      tabMember.addEventListener('click', () => {
        tabMember.classList.add('active');
        tabStock.classList.remove('active');
        memberSection.style.display = '';
        stockSection.style.display = 'none';
      });
      tabStock.addEventListener('click', () => {
        tabStock.classList.add('active');
        tabMember.classList.remove('active');
        memberSection.style.display = 'none';
        stockSection.style.display = '';
      });
    });

    // 初期表示
    applySettings();
  </script>
</body>
</html>